#!/bin/bash
set -euo pipefail
echo "Creating data stack in $(pwd)"

export GIT_AUTHOR_NAME="Data Stack Service"
export GIT_AUTHOR_EMAIL="libds@leukos.io"
export GIT_COMMITTER_NAME="${GIT_AUTHOR_NAME}"
export GIT_COMMITTER_EMAIL="${GIT_AUTHOR_EMAIL}"

cat <<'EOF' > ./Dockerfile
FROM python:3.9
RUN pip install git+https://git:obvUssSTkx3e_bswWQQy@gitlab.com/leukosio/libds.git@v1-sources
RUN mkdir -p /opt/ds
WORKDIR /opt/ds/
EOF

cat <<'EOF' > ./build
#!/bin/bash
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")"
docker build --no-cache .
container_id="$(docker build -q .)"
cat <<EORUN > ./run
#!/bin/bash
set -euo pipefail
cd "\$(dirname "\${BASH_SOURCE[0]}")"
docker run -v "\$(pwd)/:/opt/ds/" "${container_id}" "\$@"
EORUN
chmod +x ./run
EOF

chmod +x ./build
./build

cat <<EOF > ./data_stack.yaml
created_at: "$(date --iso-8601=seconds)"
EOF

git init .
git add .
git commit --message "Bootstrap data stack"
git branch prd master
git checkout prd
git branch -D master
