#!/bin/bash
set -euo pipefail
echo "Creating data stack in $(pwd)"

export GIT_AUTHOR_NAME="Data Stack Service"
export GIT_AUTHOR_EMAIL="libds@crvl.app"
export GIT_COMMITTER_NAME="${GIT_AUTHOR_NAME}"
export GIT_COMMITTER_EMAIL="${GIT_AUTHOR_EMAIL}"

cat <<EOF > ./run
#!/bin/bash
# AUTOGENERATED. DO NOT EDIT.
# ${DIAAS_DEPLOYMENT_COMMIT_SHA} $(date --iso-8601=seconds)
set -euo pipefail
EOF

cat <<'EOF' >> ./run

cd "$(dirname "${BASH_SOURCE[0]}")"

if [[ ! -d .venv ]]; then
    python3 -m venv .venv
    source .venv/bin/activate
    pip install -U pip wheel
    pip install git+https://git:obvUssSTkx3e_bswWQQy@gitlab.com/leukosio/libds@a44eceb5d88f885d9e50cb6aac2c951bf4f5cbf0
    if [[ -e requirements.txt ]]; then
        pip install -r requirements.txt
    fi
else
    source .venv/bin/activate
fi

exec "$@"
EOF

if [[ ! -e ./data_stack.yaml ]]; then
    cat <<EOF > ./data_stack.yaml
created_at: "$(date --iso-8601=seconds)"
EOF
fi

chmod +x ./run

if [[ ! -e ./.git ]]; then
    git init .
    git add .
    git commit --message "Bootstrap data stack"
    git branch prd master
    git checkout prd
    git branch -D master
fi

