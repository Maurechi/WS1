#!/bin/bash
set -euo pipefail
echo "Creating data stack in $(pwd)"

export GIT_AUTHOR_NAME="Data Stack Service"
export GIT_AUTHOR_EMAIL="libds@leukos.io"
export GIT_COMMITTER_NAME="${GIT_AUTHOR_NAME}"
export GIT_COMMITTER_EMAIL="${GIT_AUTHOR_EMAIL}"

cat <<'EOF' > ./Dockerfile
FROM python:3.9
RUN git clone --single-branch --branch v1-transforms https://git:obvUssSTkx3e_bswWQQy@gitlab.com/leukosio/libds.git /opt/libds
RUN cd /opt/libds/ && pip install -e .[all]
RUN mkdir -p /opt/ds/
WORKDIR /opt/ds/
EOF

# NOTE we generate the `build` script in 2 steps, first with
# interpolation so we can put git info into it, and then without
# interpolation so we dnn't have to put backslashes everywhere
# 20210110:mb
cat <<EOF > ./build
#!/bin/bash
# AUTOGENERATED. DO NOT EDIT.
# $(git rev-parse --abbrev-ref HEAD) $(git rev-parse HEAD) $(date --iso-8601=seconds)
EOF

cat <<'EOF' >> ./build
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")"
docker build --no-cache .
container_id="$(docker build -q .)"
cat <<EORUN > ./run
#!/bin/bash
set -euo pipefail
cd "\$(dirname "\${BASH_SOURCE[0]}")"
declare -a run_args=( -i -v "\$(pwd)/:/opt/ds/" )
if [[ -v LIBDS_DIR ]]; then
  run_args+=( -v "\${LIBDS_DIR}/:/opt/libds/")
fi
if [[ "$(uname -s)" = "Linux" ]]; then
  run_args+=( --add-host host.docker.internal:host-gateway )
fi
docker run "\${run_args[@]}" "${container_id}" "\$@"
EORUN
chmod +x ./run
EOF

if [[ ! -e ./data_stack.yaml ]]; then
    cat <<EOF > ./data_stack.yaml
created_at: "$(date --iso-8601=seconds)"
EOF
fi

chmod +x ./build
# ./build

if [[ ! -e ./.git ]]; then
    git init .
    git add .
    git commit --message "Bootstrap data stack"
    git branch prd master
    git checkout prd
    git branch -D master
fi
