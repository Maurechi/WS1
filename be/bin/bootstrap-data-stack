#!/bin/bash
set -euo pipefail

export GIT_AUTHOR_NAME="Data Stack Service"
export GIT_AUTHOR_EMAIL="libds@crvl.app"
export GIT_COMMITTER_NAME="${GIT_AUTHOR_NAME}"
export GIT_COMMITTER_EMAIL="${GIT_AUTHOR_EMAIL}"

DIAAS_LIBDS_DIR="${DIAAS_LIBDS_DIR:-$(readlink -f "$(dirname "${BASH_SOURCE[0]}")/../../libds")}"

created_at="$(date --iso-8601=seconds)"
commit_tag="${DIAAS_DEPLOYMENT_COMMIT_SHA:-HEAD} ${created_at}"

if [[ ! -d .venv ]]; then
    python3 -m venv .venv
    source .venv/bin/activate
    pip install -U pip wheel
    pip install -e "${DIAAS_LIBDS_DIR}"[all]
    if [[ -e requirements.txt ]]; then
        pip install -r requirements.txt
    fi
else
    source .venv/bin/activate
fi

if [[ ! -e ./data_stack.yaml ]]; then
    cat <<EOF > ./data_stack.yaml
created_at: "${created_at}"
EOF
fi

if [[ ! -e ./run ]]; then
    cat <<EOF > ./run
#!/bin/bash
# AUTOGENERATED. DO NOT EDIT.
# ${commit_tag}
set -euo pipefail

dir="\$(dirname "\${BASH_SOURCE[0]}")"
source "\${dir}"/.venv/bin/activate
if [[ -e "\${dir}"/.envrc ]]; then
  source "\${dir}"/.envrc
fi

exec "\$@"
EOF
fi

chmod +x ./run

if [[ ! -e .gitignore ]]; then
    echo /.venv/ > .gitignore
fi

if [[ ! -e ./.git ]]; then
    git init .
    git add .
    git commit --message "Bootstrap from $commit_tag."
    git branch prd master
    git checkout prd
    git branch -D master
fi
