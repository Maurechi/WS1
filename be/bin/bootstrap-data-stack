#!/bin/bash
set -euo pipefail
echo "Creating data stack in $(pwd)"

export GIT_AUTHOR_NAME="Data Stack Service"
export GIT_AUTHOR_EMAIL="libds@leukos.io"
export GIT_COMMITTER_NAME="${GIT_AUTHOR_NAME}"
export GIT_COMMITTER_EMAIL="${GIT_AUTHOR_EMAIL}"

cat <<'EOF' > ./Dockerfile
FROM python:3.9
RUN pip install git+https://gitlab.com/libds/libds.git
EOF
cat <<'EOF' > ./run
#!/bin/bash
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")"
container_id="$(docker build -q .)"
if [[ $? -gt 0 ]]; then
  echo docker build failed:
  docker build .
  exit 2
fi
docker run "${container_id}" "$@"
EOF
chmod +x ./run

git init .
git add .
git commit --message "Bootstrap data stack"
git branch prd master
git checkout prd
git branch -D master
